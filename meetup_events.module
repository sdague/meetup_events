<?php

/**
 * @file
 *
 * This module allows admins to set recurrent announcements for nodes to send
 * to specified email addresses.
 */


/**
 * Implementation of hook_perm()
 */
function meetup_events_perm() {
  return array('administer meetup events');
}

/**
 * Implementaiton of hook_menu()
 */
function meetup_events_menu() {
  $items['admin/settings/meetup_events'] = array(
    'title' => 'Meetup Events',
    'description' => 'Setup Meetup Event synchronization',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('meetup_events_admin_settings'),
    'access arguments' => array('administer meetup events'),
    'type' => MENU_NORMAL_ITEM,
    'file' => 'meetup_events.admin.inc',
  );
  return $items;
}

function meetup_events_fetch_venue($node, $vfield) {
  if (!$vfield or ($vfield == "none")) {
    return;
  }
  # TODO: if it's a single name, find and return it

  # TODO: if it's a referenced field, deconstruct and find it

}

function meetup_events_fetch_date($node, $dfield) {
  $tz = date_default_timezone_get();
  date_default_timezone_set('UTC');

  $date = $node->$dfield;
  return new DateTime($date[0]["value"]);

  // Make sure to reset the timezone, we really don't want this actually global
  date_default_timezone_set($tz);
}

/**
 * Implementation of hook_nodeapi()
 */
function meetup_events_nodeapi(&$node, $op, $a3, $a4) {
  // dprint_r("Op: " . $op);
  // drupal_set_message(print_r($node, TRUE));
  /* $options = meetup_events_options_for($node->type); */
  /* # drupal_set_message("<pre>" . print_r($options, TRUE) . "</pre>"); */
  /* if ($options["date_field"]) { */
  /*   $f = $options["date_field"]; */
  /*   $date = $node->$f; */
  /*   drupal_set_message("<pre>" . print_r($date[0]["value"], TRUE) . "</pre>"); */
  /* } */
  // drupal_set_message("<pre>" . print_r($node, TRUE) . "</pre>");

  if (($op == "insert") || ($op == "update")) {
    if (meetup_events_is_type_syncable($node->type)) {
      meetup_events_sync_event($node);
    }
  }
  # TODO: enable delete
  # TODO: display "RSVP for event" on view of events
}

function meetup_events_options_for($type) {
  $values = variable_get("meetup_events", array());
  $options = array();
  $options["enabled"] = ($values[$type . "_enabled"][$type]) ? TRUE : FALSE;
  $options["date_field"] = $values[$type]["date_field"];
  $options["body"] = $values[$type]["body"];
  #drupal_set_message(print_r($values, TRUE));
  #drupal_set_message(print_r($options, TRUE));
  return $options;
}

function meetup_events_is_type_syncable($type) {
  $options = meetup_events_options_for($type);
  if ($options["enabled"]) {
    return TRUE;
  } else {
    return FALSE;
  }
}

function meetup_events_sync_event(&$node) {
  $meetupid = meetup_events_get_meetupid($node->nid);
  if ($meetupid) {
    meetup_events_update_event($meetupid, $node);
  } else {
    meetup_events_create_event($node);
  }

}

function meetup_events_save_meetupid($nid, $id) {
  $obj = (object)array(
    "nid" => $nid,
    "id" => $id,
    "last_updated" => time(),
  );
  drupal_write_record('meetup_events', $obj);
}

function meetup_events_get_meetupid($nid) {
  $event = db_fetch_object(db_query("SELECT id from {meetup_events} where nid=%d", $nid));
  if (!$event) {
    return NULL;
  } else {
    return $event->id;
  }
}

function meetup_events_node_data($node) {
  // This is a hack, but it works. There should be a way to do timezone
  // gymnastics on the DateTime field, but I'm not sure what that is yet.
  $options = meetup_events_options_for($node->type);
  $api = variable_get('meetup_api', array());

  if (!$options["date_field"]) {
    drupal_set_message("No date field specified, can't sync event. Please check your settings");
    return;
  }

  # TODO: validate date is in the future or don't submit
  $date = meetup_events_fetch_date($node, $options["date_field"]);

  # TODO: validate key / group look sane or don't submit
  # TODO: add duration
  $data = array(
    "key" => $api["key"],
    "group_id" => $api["group"],
    "name" => $node->title,
    "description" => token_replace($options["body"], 'node', $node),
    "time" => $date->getTimestamp() * 1000,
  );

  $venue = theme('meetup_events_venueid', $node);
  if ($venue) {
    # $venue comes back as a venue_id plus an optional lat, lon
    $loc = explode(",", $venue);
    $data["venue_id"] = $loc[0];
    if ($loc[1] && $loc[2]) {
      $data["lat"] = $loc[1];
      $data["lon"] = $loc[2];
    }
  }

  $request_data = http_build_query($data, '', '&');

  return $request_data;
}

function meetup_events_delete_event($id) {
  $request_url = "https://api.meetup.com/2/event/$id";
  $request_headers = array(
    'Content-Type' => 'application/x-www-form-urlencoded',
    'Accept-Charset' => 'utf-8');
  $request_method = 'DELETE';
  $data = array();

  $res = drupal_http_request($request_url, $request_headers, $request_method, $data);
  # drupal_set_message("Update '" . $res->data . "'");
  if ($res->data) {
    drupal_set_message("Deleted event from meetup");
  } else {
    drupal_set_message("Failed to delete from Meetup, you should try again later");
  }
}

function meetup_events_update_event($id, $node) {
  $request_url = "https://api.meetup.com/2/event/$id";
  $request_headers = array(
    'Content-Type' => 'application/x-www-form-urlencoded',
    'Accept-Charset' => 'utf-8');
  $request_method = 'POST';

  $data = meetup_events_node_data($node);

  $res = drupal_http_request($request_url, $request_headers, $request_method, $data);
  # drupal_set_message("Update '" . $res->data . "'");
  $data = json_decode($res->data);
  if ($data->id) {
    drupal_set_message("Updated on <a href='" . $data->event_url .  "'>Meetup</a>");
  } else {
    drupal_set_message("Failed to update Meetup, you should try again later");
  }
}

function meetup_events_create_event($node) {
  $request_url = "https://api.meetup.com/2/event";
  $request_headers = array(
    'Content-Type' => 'application/x-www-form-urlencoded',
    'Accept-Charset' => 'utf-8');
  $request_method = 'POST';

  $data = meetup_events_node_data($node);

  $res = drupal_http_request($request_url, $request_headers, $request_method, $data);
#  drupal_set_message("Create '" . $res->data . "'");
  $data = json_decode($res->data);
  if ($data->id) {
    meetup_events_save_meetupid($node->nid, $data->id);
    drupal_set_message("Saved to <a href='" . $data->event_url .  "'>Meetup</a>");
  } else {
    drupal_set_message("Failed to save to Meetup, you should try again later");
  }

}

/**
 * You are going to need to modify this theme function for your environment
 */
function theme_meetup_events_venueid($node) {
  if (! $node->field_location) {
    return;
  }

  $loc = node_load($node->field_location[0]["nid"]);

  if (!$loc->field_meetupvenue) {
    return;
  }

  $venue = $loc->field_meetupvenue[0]["value"];

  if ($loc->field_meetuplat && $loc->field_meetuplon) {
    $venue .= "," . $loc->field_meetuplat[0]["value"] . "," . $loc->field_meetuplon[0]["value"];
  }

  return $venue;
}

function theme_meetup_events_body($node) {
  $boilerplate = node_load($node->field_boilerplate[0]["nid"]);
  $result = $node->body . $boilerplate->body;
  return $result;
}

function theme_meetup_events_date($node) {
  return $node->field_date[0]["value"];
}

function meetup_events_theme() {
  $path = drupal_get_path('module', 'meetup_events_theme');
  $base = array(
    'path' => "$path/theme"
  );

  // TODO: get forms in here as well, though I was having an issue getting
  // them to take parameters as well as the form parameters
  $themes = array(
    'meetup_events_venueid' => array(
      'arguments' => array('node' => NULL),
    ),
    'meetup_events_body' => array(
      'arguments' => array('node' => NULL)
    ),
    'meetup_events_date' => array(
      'arguments' => array('node' => NULL)
    )
  );
  return $themes;
}